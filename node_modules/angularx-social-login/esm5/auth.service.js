import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { BehaviorSubject, ReplaySubject, isObservable } from 'rxjs';
import { first } from 'rxjs/operators';
var AuthServiceConfig = /** @class */ (function () {
    function AuthServiceConfig(providers) {
        var _this = this;
        this.lazyLoad = false;
        this.providers = new Map();
        this._ready = new ReplaySubject();
        if (isObservable(providers)) {
            providers.pipe(first()).subscribe(function (providerList) {
                _this.initialize(providerList);
            });
        }
        else {
            this.initialize(providers);
        }
    }
    AuthServiceConfig.prototype.initialize = function (providers) {
        for (var i = 0; i < providers.length; i++) {
            var element = providers[i];
            this.providers.set(element.id, element.provider);
            this.lazyLoad = this.lazyLoad || element.lazyLoad;
        }
        this._ready.next();
        this._ready.complete();
    };
    return AuthServiceConfig;
}());
export { AuthServiceConfig };
var AuthService = /** @class */ (function () {
    function AuthService(config) {
        var _this = this;
        this._user = null;
        this._authState = new ReplaySubject(1);
        this._readyState = new BehaviorSubject([]);
        this.initialized = false;
        config._ready.subscribe(function () {
            _this.providers = config.providers;
            if (!config.lazyLoad) {
                _this.initialize();
            }
        });
    }
    AuthService_1 = AuthService;
    Object.defineProperty(AuthService.prototype, "authState", {
        get: function () {
            return this._authState.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AuthService.prototype, "readyState", {
        /** Provides an array of provider ID's as they become ready */
        get: function () {
            return this._readyState.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    AuthService.prototype.initialize = function () {
        var _this = this;
        this.initialized = true;
        this.providers.forEach(function (provider, key) {
            provider.initialize().then(function () {
                var readyProviders = _this._readyState.getValue();
                readyProviders.push(key);
                _this._readyState.next(readyProviders);
                provider.getLoginStatus().then(function (user) {
                    user.provider = key;
                    _this._user = user;
                    _this._authState.next(user);
                }).catch(function (err) {
                    _this._authState.next(null);
                });
            });
        });
    };
    AuthService.prototype.signIn = function (providerId, opt) {
        var _this = this;
        if (!this.initialized) {
            this.initialize();
        }
        return new Promise(function (resolve, reject) {
            var providerObject = _this.providers.get(providerId);
            if (providerObject) {
                providerObject.signIn(opt).then(function (user) {
                    user.provider = providerId;
                    resolve(user);
                    _this._user = user;
                    _this._authState.next(user);
                }).catch(function (err) {
                    reject(err);
                });
            }
            else {
                reject(AuthService_1.ERR_LOGIN_PROVIDER_NOT_FOUND);
            }
        });
    };
    AuthService.prototype.signOut = function (revoke) {
        var _this = this;
        if (revoke === void 0) { revoke = false; }
        if (!this.initialized) {
            this.initialize();
        }
        return new Promise(function (resolve, reject) {
            if (!_this._user) {
                reject(AuthService_1.ERR_NOT_LOGGED_IN);
            }
            else {
                var providerId = _this._user.provider;
                var providerObject = _this.providers.get(providerId);
                if (providerObject) {
                    providerObject.signOut(revoke).then(function () {
                        resolve();
                        _this._user = null;
                        _this._authState.next(null);
                    }).catch(function (err) {
                        reject(err);
                    });
                }
                else {
                    reject(AuthService_1.ERR_LOGIN_PROVIDER_NOT_FOUND);
                }
            }
        });
    };
    var AuthService_1;
    AuthService.ERR_LOGIN_PROVIDER_NOT_FOUND = 'Login provider not found';
    AuthService.ERR_NOT_LOGGED_IN = 'Not logged in';
    AuthService.ctorParameters = function () { return [
        { type: AuthServiceConfig }
    ]; };
    AuthService = AuthService_1 = __decorate([
        Injectable()
    ], AuthService);
    return AuthService;
}());
export { AuthService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhcngtc29jaWFsLWxvZ2luLyIsInNvdXJjZXMiOlsiYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxlQUFlLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRixPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0sZ0JBQWdCLENBQUE7QUFnRnBDO0lBS0UsMkJBQVksU0FBd0U7UUFBcEYsaUJBUUM7UUFaRCxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLGNBQVMsR0FBK0IsSUFBSSxHQUFHLEVBQXlCLENBQUM7UUFDekUsV0FBTSxHQUFzQixJQUFJLGFBQWEsRUFBRSxDQUFBO1FBRzdDLElBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQzFCLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxZQUFZO2dCQUM1QyxLQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFBO1lBQy9CLENBQUMsQ0FBQyxDQUFBO1NBQ0g7YUFBTTtZQUNMLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBb0MsQ0FBQyxDQUFBO1NBQ3REO0lBQ0gsQ0FBQztJQUVELHNDQUFVLEdBQVYsVUFBVyxTQUFpQztRQUMxQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN6QyxJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLFFB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QUMsQ0FBQztvQkFDZCxDQUFDLENBQUMsQ0FBQztpQkFDSjtxQkFBTTtvQkFDTCxNQUFNLENBQUMsYUFBVyxDQUFDLDRCQUE0QixDQUFDLENBQUM7aUJBQ2xEO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7O0lBaEd1Qix3Q0FBNEIsR0FBRywwQkFBMEIsQ0FBQztJQUMxRCw2QkFBaUIsR0FBRyxlQUFlLENBQUM7O2dCQWtCeEMsaUJBQWlCOztJQXJCMUIsV0FBVztRQUR2QixVQUFVLEVBQUU7T0FDQSxXQUFXLENBb0d2QjtJQUFELGtCQUFDO0NBQUEsQUFwR0QsSUFvR0M7U0FwR1ksV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0LCBSZXBsYXlTdWJqZWN0LCBpc09ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtmaXJzdH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnXHJcbmltcG9ydCB7IExvZ2luUHJvdmlkZXIgfSBmcm9tICcuL2VudGl0aWVzL2xvZ2luLXByb3ZpZGVyJztcclxuaW1wb3J0IHsgU29jaWFsVXNlciB9IGZyb20gJy4vZW50aXRpZXMvdXNlcic7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhTZXJ2aWNlQ29uZmlnSXRlbSB7XHJcbiAgaWQ6IHN0cmluZztcclxuICBwcm92aWRlcjogTG9naW5Qcm92aWRlcjtcclxuICAvKipcclxuICAgKiBUaGlzIGZpZWxkIGFsbG93cyB0byBsb2FkIGxvZ2luIHByb3ZpZGVycyBTREtzIGxhemlseS5cclxuICAgKiBMYXp5IGxvYWRpbmcgaXMgYWN0aXZhdGVkIGlmIGl0J3MgdHJ1ZSBhbmQgdmljZSB2ZXJzYS5cclxuICAgKi9cclxuICBsYXp5TG9hZD86IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgTG9naW5PcHQge1xyXG4gIC8qKlxyXG4gICAqIEZhY2Vib29rIEZCLmxvZ2luIG9wdGlvbnM6IGh0dHBzOi8vZGV2ZWxvcGVycy5mYWNlYm9vay5jb20vZG9jcy9yZWZlcmVuY2UvamF2YXNjcmlwdC9GQi5sb2dpbi92Mi4xMS5cclxuICAgKi9cclxuICBhdXRoX3R5cGU/OiBzdHJpbmc7IC8vIE9wdGlvbmFsIGtleSwgb25seSBzdXBwb3J0cyBvbmUgdmFsdWU6IHJlcmVxdWVzdC4gVXNlIHRoaXMgd2hlbiByZS1yZXF1ZXN0aW5nIGEgZGVjbGluZWQgcGVybWlzc2lvbi5cclxuICBzY29wZT86IHN0cmluZzsgLy8gQ29tbWEgc2VwYXJhdGVkIGxpc3Qgb2YgZXh0ZW5kZWQgcGVybWlzc2lvbnNcclxuICByZXR1cm5fc2NvcGVzPzogYm9vbGVhbjsgLy8gV2hlbiB0cnVlLCB0aGUgZ3JhbnRlZCBzY29wZXMgd2lsbCBiZSByZXR1cm5lZCBpbiBhIGNvbW1hLXNlcGFyYXRlZCBsaXN0LlxyXG4gIGVuYWJsZV9wcm9maWxlX3NlbGVjdG9yPzogYm9vbGVhbjsgLy8gV2hlbiB0cnVlLCBwcm9tcHQgdGhlIHVzZXIgdG8gZ3JhbnQgcGVybWlzc2lvbiBmb3Igb25lIG9yIG1vcmUgUGFnZXMuXHJcbiAgcHJvZmlsZV9zZWxlY3Rvcl9pZHM/OiBzdHJpbmc7IC8vIENvbW1hIHNlcGFyYXRlZCBsaXN0IG9mIElEcyB0byBkaXNwbGF5IGluIHRoZSBwcm9maWxlIHNlbGVjdG9yXHJcbiAgLyoqXHJcbiAgICogR29vZ2xlIGdhcGkuYXV0aDIuQ2xpZW50Q29uZmlnOiBcXFxyXG4gICAqIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2FwaS1jbGllbnQtbGlicmFyeS9qYXZhc2NyaXB0L3JlZmVyZW5jZS9yZWZlcmVuY2Vkb2NzI2dhcGlhdXRoMmNsaWVudGNvbmZpZy5cclxuICAgKi9cclxuICAvKiBSZXF1aXJlZC4gVGhlIGFwcCdzIGNsaWVudCBJRCwgZm91bmQgYW5kIGNyZWF0ZWQgaW4gdGhlIEdvb2dsZSBEZXZlbG9wZXJzIENvbnNvbGUuKi9cclxuICBjbGllbnRfaWQ/OiBzdHJpbmc7XHJcbiAgLyogVGhlIGRvbWFpbnMgZm9yIHdoaWNoIHRvIGNyZWF0ZSBzaWduLWluIGNvb2tpZXMuIEVpdGhlciBhIFVSSSxcclxuICBzaW5nbGVfaG9zdF9vcmlnaW4sIG9yIG5vbmUuIERlZmF1bHRzIHRvIHNpbmdsZV9ob3N0X29yaWdpbiBpZiB1bnNwZWNpZmllZC4gKi9cclxuICBjb29raWVfcG9saWN5Pzogc3RyaW5nO1xyXG4gIC8qIEZldGNoIHVzZXJzJyBiYXNpYyBwcm9maWxlIGluZm9ybWF0aW9uIHdoZW4gdGhleSBzaWduIGluLiBBZGRzICdwcm9maWxlJyxcclxuICAnZW1haWwnIGFuZCAnb3BlbmlkJyB0byB0aGUgcmVxdWVzdGVkIHNjb3Blcy4gVHJ1ZSBpZiB1bnNwZWNpZmllZC4gKi9cclxuICBmZXRjaF9iYXNpY19wcm9maWxlPzogYm9vbGVhbjtcclxuICAvKiBUaGUgRyBTdWl0ZSBkb21haW4gdG8gd2hpY2ggdXNlcnMgbXVzdCBiZWxvbmcgdG8gc2lnbiBpbi5cclxuICBUaGlzIGlzIHN1c2NlcHRpYmxlIHRvIG1vZGlmaWNhdGlvbiBieSBjbGllbnRzLCBzbyBiZSBzdXJlIHRvIHZlcmlmeVxyXG4gIHRoZSBob3N0ZWQgZG9tYWluIHByb3BlcnR5IG9mIHRoZSByZXR1cm5lZCB1c2VyLlxyXG4gIFVzZSBHb29nbGVVc2VyLmdldEhvc3RlZERvbWFpbigpIG9uIHRoZSBjbGllbnQsIGFuZCB0aGUgaGQgY2xhaW0gaW5cclxuICB0aGUgSUQgVG9rZW4gb24gdGhlIHNlcnZlciB0byB2ZXJpZnkgdGhlIGRvbWFpbiBpcyB3aGF0IHlvdSBleHBlY3RlZC4gKi9cclxuICBob3N0ZWRfZG9tYWluPzogc3RyaW5nO1xyXG4gIC8qIFVzZWQgb25seSBmb3IgT3BlbklEIDIuMCBjbGllbnQgbWlncmF0aW9uLiBTZXQgdG8gdGhlIHZhbHVlXHJcbiAgb2YgdGhlIHJlYWxtIHRoYXQgeW91IGFyZSBjdXJyZW50bHkgdXNpbmcgZm9yIE9wZW5JRCAyLjAsXHJcbiAgYXMgZGVzY3JpYmVkIGluIE9wZW5JRCAyLjAgKE1pZ3JhdGlvbikuICovXHJcbiAgb3BlbmlkX3JlYWxtPzogc3RyaW5nO1xyXG4gIC8qIFRoZSBVWCBtb2RlIHRvIHVzZSBmb3IgdGhlIHNpZ24taW4gZmxvdy4gQnkgZGVmYXVsdCwgaXQgd2lsbCBvcGVuIHRoZSBjb25zZW50IGZsb3cgaW4gYSBwb3B1cC4gVmFsaWQgdmFsdWVzIGFyZSBwb3B1cCBhbmQgcmVkaXJlY3QuICovXHJcbiAgdXhfbW9kZT86IHN0cmluZztcclxuICAvKiBJZiB1c2luZyB1eF9tb2RlPSdyZWRpcmVjdCcsIHRoaXMgcGFyYW1ldGVyIGFsbG93cyB5b3UgdG8gb3ZlcnJpZGVcclxuICB0aGUgZGVmYXVsdCByZWRpcmVjdF91cmkgdGhhdCB3aWxsIGJlIHVzZWQgYXQgdGhlIGVuZCBvZiB0aGUgY29uc2VudCBmbG93LlxyXG4gIFRoZSBkZWZhdWx0IHJlZGlyZWN0X3VyaSBpcyB0aGUgY3VycmVudCBVUkwgc3RyaXBwZWQgb2YgcXVlcnkgcGFyYW1ldGVyc1xyXG4gIGFuZCBoYXNoIGZyYWdtZW50LiAqL1xyXG4gIHJlZGlyZWN0X3VyaT86IHN0cmluZztcclxuICAvKiBHZXQgcGVybWlzc2lvbiBmcm9tIHRoZSB1c2VyIHRvIGFjY2VzcyB0aGUgc3BlY2lmaWVkIHNjb3BlcyBvZmZsaW5lLFxyXG4gICAqIElmIHVzaW5nIG9mZmxpbmVfYWNjZXNzPXRydWUsIEdvb2dsZUF1dGguZ3JhbnRPZmZsaW5lQWNjZXNzKCkgd2lsbCBiZSB1c2UgaW5zdGVhZCBvZiBHb29nbGVBdXRoLnNpZ25JbigpXHJcbiAgICovXHJcbiAgb2ZmbGluZV9hY2Nlc3M/OiBib29sZWFuO1xyXG4gIC8qXHJcbiAgIEEgc3BhY2UtZGVsaW1pdGVkIGxpc3Qgb2Ygc3RyaW5nIHZhbHVlcyB0aGF0IHNwZWNpZmllcyB3aGV0aGVyIHRoZSBhdXRob3JpemF0aW9uIHNlcnZlciBwcm9tcHRzIHRoZSB1c2VyIGZvciByZWF1dGhlbnRpY2F0aW9uXHJcbiAgIGFuZCBjb25zZW50LiBUaGUgcG9zc2libGUgdmFsdWVzIGFyZTpcclxuICAgIG5vbmVcclxuICAgICAgVGhlIGF1dGhvcml6YXRpb24gc2VydmVyIGRvZXMgbm90IGRpc3BsYXkgYW55IGF1dGhlbnRpY2F0aW9uIG9yIHVzZXIgY29uc2VudCBzY3JlZW5zOyBpdCB3aWxsIHJldHVybiBhbiBlcnJvciBpZiB0aGUgdXNlciBpcyBub3RcclxuICAgICAgYWxyZWFkeSBhdXRoZW50aWNhdGVkIGFuZCBoYXMgbm90IHByZS1jb25maWd1cmVkIGNvbnNlbnQgZm9yIHRoZSByZXF1ZXN0ZWQgc2NvcGVzLiBZb3UgY2FuIHVzZSBub25lIHRvIGNoZWNrIGZvciBleGlzdGluZ1xyXG4gICAgICBhdXRoZW50aWNhdGlvbiBhbmQvb3IgY29uc2VudC5cclxuICAgIGNvbnNlbnRcclxuICAgICAgVGhlIGF1dGhvcml6YXRpb24gc2VydmVyIHByb21wdHMgdGhlIHVzZXIgZm9yIGNvbnNlbnQgYmVmb3JlIHJldHVybmluZyBpbmZvcm1hdGlvbiB0byB0aGUgY2xpZW50LlxyXG4gICAgc2VsZWN0X2FjY291bnRcclxuICAgICAgVGhlIGF1dGhvcml6YXRpb24gc2VydmVyIHByb21wdHMgdGhlIHVzZXIgdG8gc2VsZWN0IGEgdXNlciBhY2NvdW50LiBUaGlzIGFsbG93cyBhIHVzZXIgd2hvIGhhcyBtdWx0aXBsZSBhY2NvdW50cyBhdCB0aGUgYXV0aG9yaXphdGlvblxyXG4gICAgICBzZXJ2ZXIgdG8gc2VsZWN0IGFtb25nc3QgdGhlIG11bHRpcGxlIGFjY291bnRzIHRoYXQgdGhleSBtYXkgaGF2ZSBjdXJyZW50IHNlc3Npb25zIGZvci5cclxuXHJcbiAgIElmIG5vIHZhbHVlIGlzIHNwZWNpZmllZCBhbmQgdGhlIHVzZXIgaGFzIG5vdCBwcmV2aW91c2x5IGF1dGhvcml6ZWQgYWNjZXNzLCB0aGVuIHRoZSB1c2VyIGlzIHNob3duIGEgY29uc2VudCBzY3JlZW4uXHJcbiAgKi9cclxuICBwcm9tcHQ/OiBzdHJpbmc7XHJcbiAgLypcclxuICAgIFRoZSBlbWFpbCwgb3IgVXNlciBJRCwgb2YgYSB1c2VyIHRvIHByZS1zZWxlY3QgaW4gdGhlIHNpZ24taW4gZmxvdy4gXHJcbiAgICBUaGlzIGlzIHN1c2NlcHRpYmxlIHRvIG1vZGlmaWNhdGlvbiBieSB0aGUgdXNlciwgdW5sZXNzIHByb21wdDogXCJub25lXCIgaXMgdXNlZC5cclxuICAqL1xyXG4gIGxvZ2luX2hpbnQ/OiBzdHJpbmc7XHJcblxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQXV0aFNlcnZpY2VDb25maWcge1xyXG4gIGxhenlMb2FkID0gZmFsc2U7XHJcbiAgcHJvdmlkZXJzOiBNYXA8c3RyaW5nLCBMb2dpblByb3ZpZGVyPiA9IG5ldyBNYXA8c3RyaW5nLCBMb2dpblByb3ZpZGVyPigpO1xyXG4gIF9yZWFkeTpSZXBsYXlTdWJqZWN0PGFueT4gPSBuZXcgUmVwbGF5U3ViamVjdCgpXHJcblxyXG4gIGNvbnN0cnVjdG9yKHByb3ZpZGVyczogQXV0aFNlcnZpY2VDb25maWdJdGVtW10gfCBPYnNlcnZhYmxlPEF1dGhTZXJ2aWNlQ29uZmlnSXRlbVtdPikge1xyXG4gICAgaWYoaXNPYnNlcnZhYmxlKHByb3ZpZGVycykpIHtcclxuICAgICAgcHJvdmlkZXJzLnBpcGUoZmlyc3QoKSkuc3Vic2NyaWJlKHByb3ZpZGVyTGlzdCA9PiB7XHJcbiAgICAgICAgdGhpcy5pbml0aWFsaXplKHByb3ZpZGVyTGlzdClcclxuICAgICAgfSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZShwcm92aWRlcnMgYXMgQXV0aFNlcnZpY2VDb25maWdJdGVtW10pXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXplKHByb3ZpZGVyczpBdXRoU2VydmljZUNvbmZpZ0l0ZW1bXSkge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm92aWRlcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgbGV0IGVsZW1lbnQgPSBwcm92aWRlcnNbaV07XHJcbiAgICAgIHRoaXMucHJvdmlkZXJzLnNldChlbGVtZW50LmlkLCBlbGVtZW50LnByb3ZpZGVyKTtcclxuICAgICAgdGhpcy5sYXp5TG9hZCA9IHRoaXMubGF6eUxvYWQgfHwgZWxlbWVudC5sYXp5TG9hZDtcclxuICAgICAgXHJcbiAgICB9XHJcbiAgICB0aGlzLl9yZWFkeS5uZXh0KClcclxuICAgIHRoaXMuX3JlYWR5LmNvbXBsZXRlKClcclxuICB9XHJcblxyXG5cclxufVxyXG5cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlIHtcclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgRVJSX0xPR0lOX1BST1ZJREVSX05PVF9GT1VORCA9ICdMb2dpbiBwcm92aWRlciBub3QgZm91bmQnO1xyXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEVSUl9OT1RfTE9HR0VEX0lOID0gJ05vdCBsb2dnZWQgaW4nO1xyXG5cclxuICBwcml2YXRlIHByb3ZpZGVyczogTWFwPHN0cmluZywgTG9naW5Qcm92aWRlcj47XHJcblxyXG4gIHByaXZhdGUgX3VzZXI6IFNvY2lhbFVzZXIgPSBudWxsO1xyXG4gIHByaXZhdGUgX2F1dGhTdGF0ZTogUmVwbGF5U3ViamVjdDxTb2NpYWxVc2VyPiA9IG5ldyBSZXBsYXlTdWJqZWN0KDEpO1xyXG4gIHByaXZhdGUgX3JlYWR5U3RhdGU6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmdbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuXHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICBnZXQgYXV0aFN0YXRlKCk6IE9ic2VydmFibGU8U29jaWFsVXNlcj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2F1dGhTdGF0ZS5hc09ic2VydmFibGUoKTtcclxuICB9XHJcbiAgLyoqIFByb3ZpZGVzIGFuIGFycmF5IG9mIHByb3ZpZGVyIElEJ3MgYXMgdGhleSBiZWNvbWUgcmVhZHkgKi9cclxuICBnZXQgcmVhZHlTdGF0ZSgpOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5fcmVhZHlTdGF0ZS5hc09ic2VydmFibGUoKTtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogQXV0aFNlcnZpY2VDb25maWcpIHtcclxuICAgIFxyXG4gICAgY29uZmlnLl9yZWFkeS5zdWJzY3JpYmUoKCkgPT4geyAgICBcclxuICAgICAgdGhpcy5wcm92aWRlcnMgPSBjb25maWcucHJvdmlkZXJzO1xyXG4gICAgICBpZiAoIWNvbmZpZy5sYXp5TG9hZCkge1xyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZSgpIHtcclxuICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgdGhpcy5wcm92aWRlcnMuZm9yRWFjaCgocHJvdmlkZXI6IExvZ2luUHJvdmlkZXIsIGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHByb3ZpZGVyLmluaXRpYWxpemUoKS50aGVuKCgpID0+IHtcclxuICAgICAgICBsZXQgcmVhZHlQcm92aWRlcnMgPSB0aGlzLl9yZWFkeVN0YXRlLmdldFZhbHVlKCk7XHJcbiAgICAgICAgcmVhZHlQcm92aWRlcnMucHVzaChrZXkpO1xyXG4gICAgICAgIHRoaXMuX3JlYWR5U3RhdGUubmV4dChyZWFkeVByb3ZpZGVycyk7XHJcblxyXG4gICAgICAgIHByb3ZpZGVyLmdldExvZ2luU3RhdHVzKCkudGhlbigodXNlcikgPT4ge1xyXG4gICAgICAgICAgdXNlci5wcm92aWRlciA9IGtleTtcclxuXHJcbiAgICAgICAgICB0aGlzLl91c2VyID0gdXNlcjtcclxuICAgICAgICAgIHRoaXMuX2F1dGhTdGF0ZS5uZXh0KHVzZXIpO1xyXG4gICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgIHRoaXMuX2F1dGhTdGF0ZS5uZXh0KG51bGwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2lnbkluKHByb3ZpZGVySWQ6IHN0cmluZywgb3B0PzogTG9naW5PcHQpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xyXG4gICAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGxldCBwcm92aWRlck9iamVjdCA9IHRoaXMucHJvdmlkZXJzLmdldChwcm92aWRlcklkKTtcclxuICAgICAgaWYgKHByb3ZpZGVyT2JqZWN0KSB7XHJcbiAgICAgICAgcHJvdmlkZXJPYmplY3Quc2lnbkluKG9wdCkudGhlbigodXNlcjogU29jaWFsVXNlcikgPT4ge1xyXG4gICAgICAgICAgdXNlci5wcm92aWRlciA9IHByb3ZpZGVySWQ7XHJcbiAgICAgICAgICByZXNvbHZlKHVzZXIpO1xyXG5cclxuICAgICAgICAgIHRoaXMuX3VzZXIgPSB1c2VyO1xyXG4gICAgICAgICAgdGhpcy5fYXV0aFN0YXRlLm5leHQodXNlcik7XHJcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlamVjdChBdXRoU2VydmljZS5FUlJfTE9HSU5fUFJPVklERVJfTk9UX0ZPVU5EKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzaWduT3V0KHJldm9rZTogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xyXG4gICAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAoIXRoaXMuX3VzZXIpIHtcclxuICAgICAgICByZWplY3QoQXV0aFNlcnZpY2UuRVJSX05PVF9MT0dHRURfSU4pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCBwcm92aWRlcklkID0gdGhpcy5fdXNlci5wcm92aWRlcjtcclxuICAgICAgICBsZXQgcHJvdmlkZXJPYmplY3QgPSB0aGlzLnByb3ZpZGVycy5nZXQocHJvdmlkZXJJZCk7XHJcbiAgICAgICAgaWYgKHByb3ZpZGVyT2JqZWN0KSB7XHJcbiAgICAgICAgICBwcm92aWRlck9iamVjdC5zaWduT3V0KHJldm9rZSkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3VzZXIgPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLl9hdXRoU3RhdGUubmV4dChudWxsKTtcclxuICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVqZWN0KEF1dGhTZXJ2aWNlLkVSUl9MT0dJTl9QUk9WSURFUl9OT1RfRk9VTkQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=