var AuthService_1;
import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { BehaviorSubject, ReplaySubject, isObservable } from 'rxjs';
import { first } from 'rxjs/operators';
export class AuthServiceConfig {
    constructor(providers) {
        this.lazyLoad = false;
        this.providers = new Map();
        this._ready = new ReplaySubject();
        if (isObservable(providers)) {
            providers.pipe(first()).subscribe(providerList => {
                this.initialize(providerList);
            });
        }
        else {
            this.initialize(providers);
        }
    }
    initialize(providers) {
        for (let i = 0; i < providers.length; i++) {
            let element = providers[i];
            this.providers.set(element.id, element.provider);
            this.lazyLoad = this.lazyLoad || element.lazyLoad;
        }
        this._ready.next();
        this._ready.complete();
    }
}
let AuthService = AuthService_1 = class AuthService {
    constructor(config) {
        this._user = null;
        this._authState = new ReplaySubject(1);
        this._readyState = new BehaviorSubject([]);
        this.initialized = false;
        config._ready.subscribe(() => {
            this.providers = config.providers;
            if (!config.lazyLoad) {
                this.initialize();
            }
        });
    }
    get authState() {
        return this._authState.asObservable();
    }
    /** Provides an array of provider ID's as they become ready */
    get readyState() {
        return this._readyState.asObservable();
    }
    initialize() {
        this.initialized = true;
        this.providers.forEach((provider, key) => {
            provider.initialize().then(() => {
                let readyProviders = this._readyState.getValue();
                readyProviders.push(key);
                this._readyState.next(readyProviders);
                provider.getLoginStatus().then((user) => {
                    user.provider = key;
                    this._user = user;
                    this._authState.next(user);
                }).catch((err) => {
                    this._authState.next(null);
                });
            });
        });
    }
    signIn(providerId, opt) {
        if (!this.initialized) {
            this.initialize();
        }
        return new Promise((resolve, reject) => {
            let providerObject = this.providers.get(providerId);
            if (providerObject) {
                providerObject.signIn(opt).then((user) => {
                    user.provider = providerId;
                    resolve(user);
                    this._user = user;
                    this._authState.next(user);
                }).catch(err => {
                    reject(err);
                });
            }
            else {
                reject(AuthService_1.ERR_LOGIN_PROVIDER_NOT_FOUND);
            }
        });
    }
    signOut(revoke = false) {
        if (!this.initialized) {
            this.initialize();
        }
        return new Promise((resolve, reject) => {
            if (!this._user) {
                reject(AuthService_1.ERR_NOT_LOGGED_IN);
            }
            else {
                let providerId = this._user.provider;
                let providerObject = this.providers.get(providerId);
                if (providerObject) {
                    providerObject.signOut(revoke).then(() => {
                        resolve();
                        this._user = null;
                        this._authState.next(null);
                    }).catch((err) => {
                        reject(err);
                    });
                }
                else {
                    reject(AuthService_1.ERR_LOGIN_PROVIDER_NOT_FOUND);
                }
            }
        });
    }
};
AuthService.ERR_LOGIN_PROVIDER_NOT_FOUND = 'Login provider not found';
AuthService.ERR_NOT_LOGGED_IN = 'Not logged in';
AuthService.ctorParameters = () => [
    { type: AuthServiceConfig }
];
AuthService = AuthService_1 = __decorate([
    Injectable()
], AuthService);
export { AuthService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhcngtc29jaWFsLWxvZ2luLyIsInNvdXJjZXMiOlsiYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsZUFBZSxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEYsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLGdCQUFnQixDQUFBO0FBZ0ZwQyxNQUFNLE9BQU8saUJBQWlCO0lBSzVCLFlBQVksU0FBd0U7UUFKcEYsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNqQixjQUFTLEdBQStCLElBQUksR0FBRyxFQUF5QixDQUFDO1FBQ3pFLFdBQU0sR0FBc0IsSUFBSSxhQUFhLEVBQUUsQ0FBQTtRQUc3QyxJQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUMxQixTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUMvQyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFBO1lBQy9CLENBQUMsQ0FBQyxDQUFBO1NBQ0g7YUFBTTtZQUNMLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBb0MsQ0FBQyxDQUFBO1NBQ3REO0lBQ0gsQ0FBQztJQUVELFVBQVUsQ0FBQyxTQUFpQztRQUMxQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN6QyxJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakQsSUFBSSxD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LENBQUMsQ0FBQztpQkFDSjtxQkFBTTtvQkFDTCxNQUFNLENBQUMsYUFBVyxDQUFDLDRCQUE0QixDQUFDLENBQUM7aUJBQ2xEO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FFRixDQUFBO0FBbEd5Qix3Q0FBNEIsR0FBRywwQkFBMEIsQ0FBQztBQUMxRCw2QkFBaUIsR0FBRyxlQUFlLENBQUM7O1lBa0J4QyxpQkFBaUI7O0FBckIxQixXQUFXO0lBRHZCLFVBQVUsRUFBRTtHQUNBLFdBQVcsQ0FvR3ZCO1NBcEdZLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCwgUmVwbGF5U3ViamVjdCwgaXNPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7Zmlyc3R9IGZyb20gJ3J4anMvb3BlcmF0b3JzJ1xyXG5pbXBvcnQgeyBMb2dpblByb3ZpZGVyIH0gZnJvbSAnLi9lbnRpdGllcy9sb2dpbi1wcm92aWRlcic7XHJcbmltcG9ydCB7IFNvY2lhbFVzZXIgfSBmcm9tICcuL2VudGl0aWVzL3VzZXInO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBBdXRoU2VydmljZUNvbmZpZ0l0ZW0ge1xyXG4gIGlkOiBzdHJpbmc7XHJcbiAgcHJvdmlkZXI6IExvZ2luUHJvdmlkZXI7XHJcbiAgLyoqXHJcbiAgICogVGhpcyBmaWVsZCBhbGxvd3MgdG8gbG9hZCBsb2dpbiBwcm92aWRlcnMgU0RLcyBsYXppbHkuXHJcbiAgICogTGF6eSBsb2FkaW5nIGlzIGFjdGl2YXRlZCBpZiBpdCdzIHRydWUgYW5kIHZpY2UgdmVyc2EuXHJcbiAgICovXHJcbiAgbGF6eUxvYWQ/OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIExvZ2luT3B0IHtcclxuICAvKipcclxuICAgKiBGYWNlYm9vayBGQi5sb2dpbiBvcHRpb25zOiBodHRwczovL2RldmVsb3BlcnMuZmFjZWJvb2suY29tL2RvY3MvcmVmZXJlbmNlL2phdmFzY3JpcHQvRkIubG9naW4vdjIuMTEuXHJcbiAgICovXHJcbiAgYXV0aF90eXBlPzogc3RyaW5nOyAvLyBPcHRpb25hbCBrZXksIG9ubHkgc3VwcG9ydHMgb25lIHZhbHVlOiByZXJlcXVlc3QuIFVzZSB0aGlzIHdoZW4gcmUtcmVxdWVzdGluZyBhIGRlY2xpbmVkIHBlcm1pc3Npb24uXHJcbiAgc2NvcGU/OiBzdHJpbmc7IC8vIENvbW1hIHNlcGFyYXRlZCBsaXN0IG9mIGV4dGVuZGVkIHBlcm1pc3Npb25zXHJcbiAgcmV0dXJuX3Njb3Blcz86IGJvb2xlYW47IC8vIFdoZW4gdHJ1ZSwgdGhlIGdyYW50ZWQgc2NvcGVzIHdpbGwgYmUgcmV0dXJuZWQgaW4gYSBjb21tYS1zZXBhcmF0ZWQgbGlzdC5cclxuICBlbmFibGVfcHJvZmlsZV9zZWxlY3Rvcj86IGJvb2xlYW47IC8vIFdoZW4gdHJ1ZSwgcHJvbXB0IHRoZSB1c2VyIHRvIGdyYW50IHBlcm1pc3Npb24gZm9yIG9uZSBvciBtb3JlIFBhZ2VzLlxyXG4gIHByb2ZpbGVfc2VsZWN0b3JfaWRzPzogc3RyaW5nOyAvLyBDb21tYSBzZXBhcmF0ZWQgbGlzdCBvZiBJRHMgdG8gZGlzcGxheSBpbiB0aGUgcHJvZmlsZSBzZWxlY3RvclxyXG4gIC8qKlxyXG4gICAqIEdvb2dsZSBnYXBpLmF1dGgyLkNsaWVudENvbmZpZzogXFxcclxuICAgKiBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9hcGktY2xpZW50LWxpYnJhcnkvamF2YXNjcmlwdC9yZWZlcmVuY2UvcmVmZXJlbmNlZG9jcyNnYXBpYXV0aDJjbGllbnRjb25maWcuXHJcbiAgICovXHJcbiAgLyogUmVxdWlyZWQuIFRoZSBhcHAncyBjbGllbnQgSUQsIGZvdW5kIGFuZCBjcmVhdGVkIGluIHRoZSBHb29nbGUgRGV2ZWxvcGVycyBDb25zb2xlLiovXHJcbiAgY2xpZW50X2lkPzogc3RyaW5nO1xyXG4gIC8qIFRoZSBkb21haW5zIGZvciB3aGljaCB0byBjcmVhdGUgc2lnbi1pbiBjb29raWVzLiBFaXRoZXIgYSBVUkksXHJcbiAgc2luZ2xlX2hvc3Rfb3JpZ2luLCBvciBub25lLiBEZWZhdWx0cyB0byBzaW5nbGVfaG9zdF9vcmlnaW4gaWYgdW5zcGVjaWZpZWQuICovXHJcbiAgY29va2llX3BvbGljeT86IHN0cmluZztcclxuICAvKiBGZXRjaCB1c2VycycgYmFzaWMgcHJvZmlsZSBpbmZvcm1hdGlvbiB3aGVuIHRoZXkgc2lnbiBpbi4gQWRkcyAncHJvZmlsZScsXHJcbiAgJ2VtYWlsJyBhbmQgJ29wZW5pZCcgdG8gdGhlIHJlcXVlc3RlZCBzY29wZXMuIFRydWUgaWYgdW5zcGVjaWZpZWQuICovXHJcbiAgZmV0Y2hfYmFzaWNfcHJvZmlsZT86IGJvb2xlYW47XHJcbiAgLyogVGhlIEcgU3VpdGUgZG9tYWluIHRvIHdoaWNoIHVzZXJzIG11c3QgYmVsb25nIHRvIHNpZ24gaW4uXHJcbiAgVGhpcyBpcyBzdXNjZXB0aWJsZSB0byBtb2RpZmljYXRpb24gYnkgY2xpZW50cywgc28gYmUgc3VyZSB0byB2ZXJpZnlcclxuICB0aGUgaG9zdGVkIGRvbWFpbiBwcm9wZXJ0eSBvZiB0aGUgcmV0dXJuZWQgdXNlci5cclxuICBVc2UgR29vZ2xlVXNlci5nZXRIb3N0ZWREb21haW4oKSBvbiB0aGUgY2xpZW50LCBhbmQgdGhlIGhkIGNsYWltIGluXHJcbiAgdGhlIElEIFRva2VuIG9uIHRoZSBzZXJ2ZXIgdG8gdmVyaWZ5IHRoZSBkb21haW4gaXMgd2hhdCB5b3UgZXhwZWN0ZWQuICovXHJcbiAgaG9zdGVkX2RvbWFpbj86IHN0cmluZztcclxuICAvKiBVc2VkIG9ubHkgZm9yIE9wZW5JRCAyLjAgY2xpZW50IG1pZ3JhdGlvbi4gU2V0IHRvIHRoZSB2YWx1ZVxyXG4gIG9mIHRoZSByZWFsbSB0aGF0IHlvdSBhcmUgY3VycmVudGx5IHVzaW5nIGZvciBPcGVuSUQgMi4wLFxyXG4gIGFzIGRlc2NyaWJlZCBpbiBPcGVuSUQgMi4wIChNaWdyYXRpb24pLiAqL1xyXG4gIG9wZW5pZF9yZWFsbT86IHN0cmluZztcclxuICAvKiBUaGUgVVggbW9kZSB0byB1c2UgZm9yIHRoZSBzaWduLWluIGZsb3cuIEJ5IGRlZmF1bHQsIGl0IHdpbGwgb3BlbiB0aGUgY29uc2VudCBmbG93IGluIGEgcG9wdXAuIFZhbGlkIHZhbHVlcyBhcmUgcG9wdXAgYW5kIHJlZGlyZWN0LiAqL1xyXG4gIHV4X21vZGU/OiBzdHJpbmc7XHJcbiAgLyogSWYgdXNpbmcgdXhfbW9kZT0ncmVkaXJlY3QnLCB0aGlzIHBhcmFtZXRlciBhbGxvd3MgeW91IHRvIG92ZXJyaWRlXHJcbiAgdGhlIGRlZmF1bHQgcmVkaXJlY3RfdXJpIHRoYXQgd2lsbCBiZSB1c2VkIGF0IHRoZSBlbmQgb2YgdGhlIGNvbnNlbnQgZmxvdy5cclxuICBUaGUgZGVmYXVsdCByZWRpcmVjdF91cmkgaXMgdGhlIGN1cnJlbnQgVVJMIHN0cmlwcGVkIG9mIHF1ZXJ5IHBhcmFtZXRlcnNcclxuICBhbmQgaGFzaCBmcmFnbWVudC4gKi9cclxuICByZWRpcmVjdF91cmk/OiBzdHJpbmc7XHJcbiAgLyogR2V0IHBlcm1pc3Npb24gZnJvbSB0aGUgdXNlciB0byBhY2Nlc3MgdGhlIHNwZWNpZmllZCBzY29wZXMgb2ZmbGluZSxcclxuICAgKiBJZiB1c2luZyBvZmZsaW5lX2FjY2Vzcz10cnVlLCBHb29nbGVBdXRoLmdyYW50T2ZmbGluZUFjY2VzcygpIHdpbGwgYmUgdXNlIGluc3RlYWQgb2YgR29vZ2xlQXV0aC5zaWduSW4oKVxyXG4gICAqL1xyXG4gIG9mZmxpbmVfYWNjZXNzPzogYm9vbGVhbjtcclxuICAvKlxyXG4gICBBIHNwYWNlLWRlbGltaXRlZCBsaXN0IG9mIHN0cmluZyB2YWx1ZXMgdGhhdCBzcGVjaWZpZXMgd2hldGhlciB0aGUgYXV0aG9yaXphdGlvbiBzZXJ2ZXIgcHJvbXB0cyB0aGUgdXNlciBmb3IgcmVhdXRoZW50aWNhdGlvblxyXG4gICBhbmQgY29uc2VudC4gVGhlIHBvc3NpYmxlIHZhbHVlcyBhcmU6XHJcbiAgICBub25lXHJcbiAgICAgIFRoZSBhdXRob3JpemF0aW9uIHNlcnZlciBkb2VzIG5vdCBkaXNwbGF5IGFueSBhdXRoZW50aWNhdGlvbiBvciB1c2VyIGNvbnNlbnQgc2NyZWVuczsgaXQgd2lsbCByZXR1cm4gYW4gZXJyb3IgaWYgdGhlIHVzZXIgaXMgbm90XHJcbiAgICAgIGFscmVhZHkgYXV0aGVudGljYXRlZCBhbmQgaGFzIG5vdCBwcmUtY29uZmlndXJlZCBjb25zZW50IGZvciB0aGUgcmVxdWVzdGVkIHNjb3Blcy4gWW91IGNhbiB1c2Ugbm9uZSB0byBjaGVjayBmb3IgZXhpc3RpbmdcclxuICAgICAgYXV0aGVudGljYXRpb24gYW5kL29yIGNvbnNlbnQuXHJcbiAgICBjb25zZW50XHJcbiAgICAgIFRoZSBhdXRob3JpemF0aW9uIHNlcnZlciBwcm9tcHRzIHRoZSB1c2VyIGZvciBjb25zZW50IGJlZm9yZSByZXR1cm5pbmcgaW5mb3JtYXRpb24gdG8gdGhlIGNsaWVudC5cclxuICAgIHNlbGVjdF9hY2NvdW50XHJcbiAgICAgIFRoZSBhdXRob3JpemF0aW9uIHNlcnZlciBwcm9tcHRzIHRoZSB1c2VyIHRvIHNlbGVjdCBhIHVzZXIgYWNjb3VudC4gVGhpcyBhbGxvd3MgYSB1c2VyIHdobyBoYXMgbXVsdGlwbGUgYWNjb3VudHMgYXQgdGhlIGF1dGhvcml6YXRpb25cclxuICAgICAgc2VydmVyIHRvIHNlbGVjdCBhbW9uZ3N0IHRoZSBtdWx0aXBsZSBhY2NvdW50cyB0aGF0IHRoZXkgbWF5IGhhdmUgY3VycmVudCBzZXNzaW9ucyBmb3IuXHJcblxyXG4gICBJZiBubyB2YWx1ZSBpcyBzcGVjaWZpZWQgYW5kIHRoZSB1c2VyIGhhcyBub3QgcHJldmlvdXNseSBhdXRob3JpemVkIGFjY2VzcywgdGhlbiB0aGUgdXNlciBpcyBzaG93biBhIGNvbnNlbnQgc2NyZWVuLlxyXG4gICovXHJcbiAgcHJvbXB0Pzogc3RyaW5nO1xyXG4gIC8qXHJcbiAgICBUaGUgZW1haWwsIG9yIFVzZXIgSUQsIG9mIGEgdXNlciB0byBwcmUtc2VsZWN0IGluIHRoZSBzaWduLWluIGZsb3cuIFxyXG4gICAgVGhpcyBpcyBzdXNjZXB0aWJsZSB0byBtb2RpZmljYXRpb24gYnkgdGhlIHVzZXIsIHVubGVzcyBwcm9tcHQ6IFwibm9uZVwiIGlzIHVzZWQuXHJcbiAgKi9cclxuICBsb2dpbl9oaW50Pzogc3RyaW5nO1xyXG5cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlQ29uZmlnIHtcclxuICBsYXp5TG9hZCA9IGZhbHNlO1xyXG4gIHByb3ZpZGVyczogTWFwPHN0cmluZywgTG9naW5Qcm92aWRlcj4gPSBuZXcgTWFwPHN0cmluZywgTG9naW5Qcm92aWRlcj4oKTtcclxuICBfcmVhZHk6UmVwbGF5U3ViamVjdDxhbnk+ID0gbmV3IFJlcGxheVN1YmplY3QoKVxyXG5cclxuICBjb25zdHJ1Y3Rvcihwcm92aWRlcnM6IEF1dGhTZXJ2aWNlQ29uZmlnSXRlbVtdIHwgT2JzZXJ2YWJsZTxBdXRoU2VydmljZUNvbmZpZ0l0ZW1bXT4pIHtcclxuICAgIGlmKGlzT2JzZXJ2YWJsZShwcm92aWRlcnMpKSB7XHJcbiAgICAgIHByb3ZpZGVycy5waXBlKGZpcnN0KCkpLnN1YnNjcmliZShwcm92aWRlckxpc3QgPT4ge1xyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZShwcm92aWRlckxpc3QpXHJcbiAgICAgIH0pXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmluaXRpYWxpemUocHJvdmlkZXJzIGFzIEF1dGhTZXJ2aWNlQ29uZmlnSXRlbVtdKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZShwcm92aWRlcnM6QXV0aFNlcnZpY2VDb25maWdJdGVtW10pIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvdmlkZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGxldCBlbGVtZW50ID0gcHJvdmlkZXJzW2ldO1xyXG4gICAgICB0aGlzLnByb3ZpZGVycy5zZXQoZWxlbWVudC5pZCwgZWxlbWVudC5wcm92aWRlcik7XHJcbiAgICAgIHRoaXMubGF6eUxvYWQgPSB0aGlzLmxhenlMb2FkIHx8IGVsZW1lbnQubGF6eUxvYWQ7XHJcbiAgICAgIFxyXG4gICAgfVxyXG4gICAgdGhpcy5fcmVhZHkubmV4dCgpXHJcbiAgICB0aGlzLl9yZWFkeS5jb21wbGV0ZSgpXHJcbiAgfVxyXG5cclxuXHJcbn1cclxuXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBBdXRoU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEVSUl9MT0dJTl9QUk9WSURFUl9OT1RfRk9VTkQgPSAnTG9naW4gcHJvdmlkZXIgbm90IGZvdW5kJztcclxuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBFUlJfTk9UX0xPR0dFRF9JTiA9ICdOb3QgbG9nZ2VkIGluJztcclxuXHJcbiAgcHJpdmF0ZSBwcm92aWRlcnM6IE1hcDxzdHJpbmcsIExvZ2luUHJvdmlkZXI+O1xyXG5cclxuICBwcml2YXRlIF91c2VyOiBTb2NpYWxVc2VyID0gbnVsbDtcclxuICBwcml2YXRlIF9hdXRoU3RhdGU6IFJlcGxheVN1YmplY3Q8U29jaWFsVXNlcj4gPSBuZXcgUmVwbGF5U3ViamVjdCgxKTtcclxuICBwcml2YXRlIF9yZWFkeVN0YXRlOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nW10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XHJcblxyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuXHJcbiAgZ2V0IGF1dGhTdGF0ZSgpOiBPYnNlcnZhYmxlPFNvY2lhbFVzZXI+IHtcclxuICAgIHJldHVybiB0aGlzLl9hdXRoU3RhdGUuYXNPYnNlcnZhYmxlKCk7XHJcbiAgfVxyXG4gIC8qKiBQcm92aWRlcyBhbiBhcnJheSBvZiBwcm92aWRlciBJRCdzIGFzIHRoZXkgYmVjb21lIHJlYWR5ICovXHJcbiAgZ2V0IHJlYWR5U3RhdGUoKTogT2JzZXJ2YWJsZTxzdHJpbmdbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3JlYWR5U3RhdGUuYXNPYnNlcnZhYmxlKCk7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3Rvcihjb25maWc6IEF1dGhTZXJ2aWNlQ29uZmlnKSB7XHJcbiAgICBcclxuICAgIGNvbmZpZy5fcmVhZHkuc3Vic2NyaWJlKCgpID0+IHsgICAgXHJcbiAgICAgIHRoaXMucHJvdmlkZXJzID0gY29uZmlnLnByb3ZpZGVycztcclxuICAgICAgaWYgKCFjb25maWcubGF6eUxvYWQpIHtcclxuICAgICAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRpYWxpemUoKSB7XHJcbiAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgIHRoaXMucHJvdmlkZXJzLmZvckVhY2goKHByb3ZpZGVyOiBMb2dpblByb3ZpZGVyLCBrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICBwcm92aWRlci5pbml0aWFsaXplKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgbGV0IHJlYWR5UHJvdmlkZXJzID0gdGhpcy5fcmVhZHlTdGF0ZS5nZXRWYWx1ZSgpO1xyXG4gICAgICAgIHJlYWR5UHJvdmlkZXJzLnB1c2goa2V5KTtcclxuICAgICAgICB0aGlzLl9yZWFkeVN0YXRlLm5leHQocmVhZHlQcm92aWRlcnMpO1xyXG5cclxuICAgICAgICBwcm92aWRlci5nZXRMb2dpblN0YXR1cygpLnRoZW4oKHVzZXIpID0+IHtcclxuICAgICAgICAgIHVzZXIucHJvdmlkZXIgPSBrZXk7XHJcblxyXG4gICAgICAgICAgdGhpcy5fdXNlciA9IHVzZXI7XHJcbiAgICAgICAgICB0aGlzLl9hdXRoU3RhdGUubmV4dCh1c2VyKTtcclxuICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLl9hdXRoU3RhdGUubmV4dChudWxsKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHNpZ25Jbihwcm92aWRlcklkOiBzdHJpbmcsIG9wdD86IExvZ2luT3B0KTogUHJvbWlzZTxTb2NpYWxVc2VyPiB7XHJcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcclxuICAgICAgdGhpcy5pbml0aWFsaXplKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBsZXQgcHJvdmlkZXJPYmplY3QgPSB0aGlzLnByb3ZpZGVycy5nZXQocHJvdmlkZXJJZCk7XHJcbiAgICAgIGlmIChwcm92aWRlck9iamVjdCkge1xyXG4gICAgICAgIHByb3ZpZGVyT2JqZWN0LnNpZ25JbihvcHQpLnRoZW4oKHVzZXI6IFNvY2lhbFVzZXIpID0+IHtcclxuICAgICAgICAgIHVzZXIucHJvdmlkZXIgPSBwcm92aWRlcklkO1xyXG4gICAgICAgICAgcmVzb2x2ZSh1c2VyKTtcclxuXHJcbiAgICAgICAgICB0aGlzLl91c2VyID0gdXNlcjtcclxuICAgICAgICAgIHRoaXMuX2F1dGhTdGF0ZS5uZXh0KHVzZXIpO1xyXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZWplY3QoQXV0aFNlcnZpY2UuRVJSX0xPR0lOX1BST1ZJREVSX05PVF9GT1VORCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2lnbk91dChyZXZva2U6IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8YW55PiB7XHJcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcclxuICAgICAgdGhpcy5pbml0aWFsaXplKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLl91c2VyKSB7XHJcbiAgICAgICAgcmVqZWN0KEF1dGhTZXJ2aWNlLkVSUl9OT1RfTE9HR0VEX0lOKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgcHJvdmlkZXJJZCA9IHRoaXMuX3VzZXIucHJvdmlkZXI7XHJcbiAgICAgICAgbGV0IHByb3ZpZGVyT2JqZWN0ID0gdGhpcy5wcm92aWRlcnMuZ2V0KHByb3ZpZGVySWQpO1xyXG4gICAgICAgIGlmIChwcm92aWRlck9iamVjdCkge1xyXG4gICAgICAgICAgcHJvdmlkZXJPYmplY3Quc2lnbk91dChyZXZva2UpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLl91c2VyID0gbnVsbDtcclxuICAgICAgICAgICAgdGhpcy5fYXV0aFN0YXRlLm5leHQobnVsbCk7XHJcbiAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlamVjdChBdXRoU2VydmljZS5FUlJfTE9HSU5fUFJPVklERVJfTk9UX0ZPVU5EKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbn1cclxuIl19